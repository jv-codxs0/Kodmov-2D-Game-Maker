<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kodmov 2D Game Maker v1.8.1 BETA (with Joystick)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;800&family=JetBrains+Mono:wght+400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Root Variables & Global Styles --- */
        :root {
            --primary: #6366f1; /* Indigo 500 */
            --accent: #ec4899; /* Pink 500 */
            --bg-dark: #0f172a; /* Slate 900 */
            --glass: rgba(30, 41, 59, 0.7);
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-dark);
            color: #fff;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            /* Inayos ang sukat para sa mas mahusay na visibility sa desktop */
            width: 100vw;
            height: 100vh;
        }

        /* --- Global Animations & Styles --- */

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Pulse Glow for the Logo */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 0 25px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .anim-float { animation: float 6s ease-in-out infinite; }
        .anim-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .anim-logo-glow { animation: pulseGlow 4s cubic-bezier(0.5, 0, 0.5, 1) infinite, float 6s ease-in-out infinite; }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.96); }
        .beta-badge { background: rgba(22, 163, 74, 0.2); color: #4ade80; border: 1px solid rgba(22, 163, 74, 0.4); font-family: 'JetBrains Mono', monospace; }

        /* --- Scene Management --- */

        .scene {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            display: none;
            flex-direction: column;
            transition: opacity 0.3s ease-in-out;
        }
        .scene.active { display: flex; }
        .scene.hidden-fade { opacity: 0; }

        /* --- Editor Specific Styles --- */

        #gameCanvas {
            /* Grid background for editor view */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #1e293b;
            touch-action: none;
            cursor: crosshair;
        }

        /* Inspector */
        #inspector {
             /* Binaba ito ng 120px para hindi matakpan ang toolbar sa ibaba */
             bottom: 120px; 
             transform: translateY(150%);
             transition: transform 0.3s ease-in-out;
        }
        #inspector.active {
             transform: translateY(0);
        }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary); margin-top: -6px; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
        
        /* Create Project Specific Styles */
        .custom-input { background: transparent; border-bottom: 2px solid #334155; transition: border-color 0.3s; }
        .custom-input:focus { outline: none; border-color: var(--primary); }
        .option-card.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.15); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }

        /* Modal Overlays */
        #sprite-picker, #about-dialog, #joystick-dialog {
            display: none;
            z-index: 100;
        }
        #sprite-picker.active, #about-dialog.active, #joystick-dialog.active {
            display: flex;
        }

        /* Custom 'K' Icon Style */
        .k-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ec4899, #6366f1);
            color: white;
            font-size: 24px;
            font-weight: 800;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
            font-family: 'Rubik', sans-serif;
        }

        /* Joystick Styles */
        #joystick-overlay {
            position: absolute;
            /* Tiyakin na hindi ito tatama sa toolbar */
            bottom: 100px; 
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 50;
        }
        #joystick-canvas {
            touch-action: none;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- BACKGROUND EFFECTS (Animated Grid) -->
    <canvas id="bgCanvas" class="fixed inset-0 pointer-events-none -z-0 opacity-20"></canvas>

    <!-- TOAST Notification -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-xl transform -translate-y-20 transition-transform duration-300 pointer-events-none flex items-center gap-2 z-50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-msg">Action Completed</span>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
        <div class="text-indigo-400 font-mono text-sm font-bold animate-pulse">GENERATING WORLD...</div>
        <div id="loading-status" class="text-slate-500 text-[10px] mt-2 font-mono">Initializing components...</div>
    </div>
    
    <!-- === SPRITE ASSET BROWSER MODAL === -->
    <div id="sprite-picker" class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm justify-center items-center">
        <div class="glass-panel w-11/12 max-w-md rounded-xl p-4 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center pb-3 border-b border-slate-700 mb-4">
                <h2 class="text-lg font-bold text-accent">Sprite Asset Browser</h2>
                <button onclick="game.closeSpritePicker()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="sprite-grid" class="grid grid-cols-6 gap-3 overflow-y-auto p-2">
                <!-- Emojis will be injected here by JS -->
            </div>
        </div>
    </div>
    
    <!-- === ABOUT DIALOG === -->
    <div id="about-dialog" class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm justify-center items-center hidden z-50">
        <div class="glass-panel w-11/12 max-w-sm rounded-xl p-6 flex flex-col items-center text-center">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-pink-500 to-red-500 mb-4 flex items-center justify-center shadow-xl">
                <i class="fa-solid fa-rocket text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-extrabold text-pink-400 mb-1">Kodmov 2D Game Maker <span class="text-sm font-semibold text-yellow-400">(V1.8.1 BETA)</span></h2>
            <p class="text-sm text-slate-300 mb-4">Simple and No-Code!</p>
            
            <a href="https://www.facebook.com/profile.php?id=61551015542995" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 mb-4 shadow-md">
                <i class="fa-brands fa-facebook mr-1"></i>
                Like/Follow My FB Page
            </a>

            <div class="text-xs font-mono text-slate-500 mt-2">
                Version 1.8.1
            </div>
            
            <button onclick="app.closeAboutDialog()" class="mt-6 w-full py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-semibold transition-colors">
                Close
            </button>
        </div>
    </div>

    <!-- === JOYSTICK DIALOG (Activation Confirmation) === -->
    <div id="joystick-dialog" class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm justify-center items-center">
        <div class="glass-panel w-11/12 max-w-xs rounded-xl p-6 flex flex-col items-center text-center">
            <i class="fa-solid fa-gamepad text-5xl text-indigo-400 mb-4 animate-bounce"></i>
            <h2 class="text-xl font-bold text-white mb-2">Joystick Activated!</h2>
            <p class="text-sm text-slate-400 mb-4">The virtual joystick will appear on the bottom-left when you enter Play Mode.</p>
            <button onclick="game.toggleJoystick(true)" class="mt-2 w-full py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-semibold transition-colors">
                OK, Ready!
            </button>
        </div>
    </div>
    

    <!-- === SCENE 0: INTRO / HOME MENU (Enhanced Aesthetics) === -->
    <div id="scene-intro" class="scene active p-6 justify-between bg-gradient-to-b from-slate-900/90 to-slate-900/95">
        <div class="mt-24 text-center anim-logo-glow"> <!-- Applied new combined animation -->
            <!-- Stylized 'K' Icon Container -->
            <div class="inline-flex items-center justify-center w-24 h-24 rounded-3xl bg-gradient-to-tr from-indigo-500 to-purple-500 mb-4 shadow-2xl shadow-indigo-500/40 transform scale-100 transition-transform duration-300">
                <div class="k-icon w-full h-full rounded-3xl text-5xl" style="background: none; box-shadow: none;">K</div>
            </div>
            <!-- Title -->
            <h1 class="text-5xl font-extrabold tracking-tighter mb-1 bg-clip-text text-transparent bg-gradient-to-r from-white to-indigo-300">
                KODMOV 2D
            </h1>
            <div class="flex items-center justify-center gap-2">
                <span class="text-pink-400 font-bold tracking-widest text-base">MOBILE GAME MAKER</span>
                <span class="beta-badge text-[10px] px-2 py-0.5 rounded-full">V1.8.1 BETA</span>
            </div>
        </div>

        <div class="w-full max-w-md mx-auto space-y-4 mb-8">
            <!-- New Project Button (Directly switches to 'create' scene) -->
            <button onclick="app.switchScene('create')" class="btn-primary w-full py-4 rounded-xl flex items-center justify-center gap-3 shadow-2xl shadow-indigo-500/30 group">
                <i class="fa-solid fa-plus-circle text-xl group-hover:rotate-6 transition-transform"></i>
                <div class="text-left">
                    <div class="font-bold text-lg leading-none">New Project</div>
                    <div class="text-[10px] opacity-80 font-mono">Start creating your game</div>
                </div>
            </button>
            
            <button onclick="app.openAboutDialog()" class="glass-panel w-full py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-700/50 transition-colors">
                <i class="fa-solid fa-info-circle text-sky-400 text-xl"></i>
                <span class="text-sm font-semibold">About Engine and Information</span>
            </button>
        </div>
        <!-- Vercel Info removed here -->
    </div>


    <!-- === SCENE 1: CREATE PROJECT === -->
    <div id="scene-create" class="scene bg-slate-900 overflow-y-auto">
         <!-- HEADER (Updated with 'K' Icon) -->
        <div class="p-4 flex items-center gap-4 z-10 shrink-0">
            <button onclick="app.switchScene('intro')" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/10 active:scale-95 transition-all text-slate-300">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div class="k-icon">K</div> <!-- The new stylized 'K' Icon -->
            <div>
                <h1 class="text-xl font-bold tracking-tight">Kodmov Edit</h1>
                <p class="text-[10px] text-slate-400 font-mono">CONFIGURE YOUR WORLD</p>
            </div>
        </div>

        <!-- MAIN FORM -->
        <div class="flex-1 px-5 pb-24 overflow-y-auto z-10">
            
            <!-- Project Name -->
            <div class="mb-8 mt-2 group">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-indigo-400 transition-colors">Project Name</label>
                <div class="relative">
                    <i class="fa-solid fa-pen absolute left-0 bottom-3 text-slate-500 text-sm"></i>
                    <input type="text" id="inp-name" class="custom-input w-full pb-2 pl-6 text-lg font-bold placeholder-slate-600 font-mono" placeholder="MyAwesomeGame_01" autocomplete="off" value="KodmovEdit">
                </div>
            </div>

            <!-- Orientation Selection -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Orientation</label>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Portrait -->
                    <div id="opt-portrait" class="option-card glass-panel rounded-xl p-4 flex flex-col items-center gap-2 cursor-pointer selected" onclick="app.selectOption('orient', this, 'portrait')">
                        <div class="w-8 h-12 border-2 border-current rounded bg-white/5 opacity-80"></div>
                        <span class="text-xs font-semibold">Portrait (Mobile)</span>
                    </div>
                    <!-- Landscape -->
                    <div id="opt-landscape" class="option-card glass-panel rounded-xl p-4 flex flex-col items-center gap-2 cursor-pointer" onclick="app.selectOption('orient', this, 'landscape')">
                        <div class="w-12 h-8 border-2 border-current rounded bg-white/5 opacity-80"></div>
                        <span class="text-xs font-semibold">Landscape (Tablet)</span>
                    </div>
                </div>
            </div>

            <!-- Physics Engine Core -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Core Engine</label>
                <div class="space-y-3">
                    <div id="opt-box2d" class="option-card glass-panel rounded-xl p-3 flex items-center gap-3 cursor-pointer selected" onclick="app.selectOption('engine', this, 'box2d')">
                        <div class="w-10 h-10 rounded-lg bg-indigo-500/20 text-indigo-400 flex items-center justify-center border border-indigo-500/30">
                            <i class="fa-solid fa-cubes"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-bold">RigidBody 2D</div>
                            <div class="text-[10px] text-slate-400">For platformers and physics games (Gravity).</div>
                        </div>
                        <i class="fa-solid fa-circle-check text-indigo-400 check-icon"></i>
                    </div>

                    <div id="opt-pixel" class="option-card glass-panel rounded-xl p-3 flex items-center gap-3 cursor-pointer" onclick="app.selectOption('engine', this, 'pixel')">
                        <div class="w-10 h-10 rounded-lg bg-pink-500/20 text-pink-400 flex items-center justify-center border border-pink-500/30">
                            <i class="fa-solid fa-border-all"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-bold">Pixel Grid</div>
                            <div class="text-[10px] text-slate-400">For Top-down RPGs and puzzle games (No Gravity).</div>
                        </div>
                        <i class="fa-regular fa-circle text-slate-600 check-icon"></i>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- CREATE BUTTON -->
        <div class="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-slate-900 via-slate-900/90 to-transparent z-20 shrink-0">
            <button onclick="app.createProject()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-bold text-lg shadow-lg shadow-indigo-500/40 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <span>Launch Engine</span>
                <i class="fa-solid fa-bolt text-yellow-300"></i>
            </button>
        </div>
    </div>


    <!-- === SCENE 2: EDITOR (MAIN GAME MAKER) === -->
    <div id="scene-editor" class="scene bg-slate-900">
        
        <!-- Editor Top Bar -->
        <div class="h-14 glass-panel flex items-center justify-between px-4 z-20 shrink-0 border-b-0">
            <button onclick="app.switchScene('intro')" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400">
                <i class="fa-solid fa-house text-sm"></i>
            </button>
            <span id="editor-project-name" class="text-xs font-mono text-slate-400">Loading...</span>
            <div class="flex gap-2">
                <button id="btn-save" class="w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center border border-indigo-500/30 hover:scale-105 active:scale-95 transition-transform">
                    <i class="fa-solid fa-save text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="flex-1 relative overflow-hidden bg-slate-800" id="editor-container">
            <canvas id="gameCanvas" class="block w-full h-full"></canvas>
            
            <!-- Play Mode Indicator -->
            <div id="play-indicator" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-green-500/20 border border-green-500/50 text-green-400 px-4 py-1 rounded-full text-sm font-bold backdrop-blur-sm pointer-events-none animate-pulse">
                <i class="fa-solid fa-gamepad mr-2"></i> PLAYING
            </div>

            <!-- Virtual Joystick Container (Only Visible in Play Mode if enabled) -->
            <div id="joystick-overlay" class="hidden">
                <canvas id="joystick-canvas" width="120" height="120"></canvas>
            </div>
        </div>
        
        <!-- PROPERTY INSPECTOR (Slide Up Panel) -->
        <div id="inspector" class="absolute left-4 right-4 glass-panel rounded-xl p-4 z-30 max-h-[50vh] overflow-y-auto flex flex-col gap-3">
            <div class="flex justify-between items-center mb-1 border-b border-slate-700 pb-2">
                <h3 class="font-bold text-sky-400 text-sm uppercase tracking-wider">Properties</h3>
                <button id="close-inspector" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>

            <!-- Name & Type -->
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-800/50 p-2 rounded border border-slate-700">
                    <label class="text-[10px] text-slate-400 block uppercase">Type</label>
                    <span id="insp-type" class="text-xs font-mono text-white">RECT</span>
                </div>
                <div class="bg-slate-800/50 p-2 rounded border border-slate-700">
                     <label class="text-[10px] text-slate-400 block uppercase">Color</label>
                     <input type="color" id="insp-color" class="w-full h-4 bg-transparent border-none p-0 cursor-pointer">
                </div>
            </div>
            
            <!-- Sprite Picker Row -->
            <div id="insp-sprite-row" class="hidden grid grid-cols-3 gap-2 bg-slate-800/50 p-2 rounded border border-slate-700">
                <div class="col-span-1">
                     <label class="text-[10px] text-slate-400 block uppercase">Current Sprite</label>
                     <div id="insp-current-sprite" class="text-xl h-6 text-center leading-none">üëæ</div>
                </div>
                <button onclick="game.openSpritePicker()" class="col-span-2 bg-pink-500/20 hover:bg-pink-500/40 text-pink-400 text-xs py-2 rounded border border-pink-500/30 transition-colors uppercase font-bold">
                     <i class="fa-solid fa-image mr-1"></i> Select Asset
                </button>
            </div>

            <!-- Transform -->
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Width</span> <span id="val-w">50</span>
                    </div>
                    <input type="range" id="insp-w" min="10" max="300" class="w-full">
                </div>
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Height</span> <span id="val-h">50</span>
                    </div>
                    <input type="range" id="insp-h" min="10" max="300" class="w-full">
                </div>
                 <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Rotation</span> <span id="val-r">0</span>
                    </div>
                    <input type="range" id="insp-r" min="0" max="360" class="w-full">
                </div>
            </div>

            <!-- Physics -->
            <div class="border-t border-slate-700 pt-3">
                <label class="text-[10px] text-sky-400 block uppercase font-bold mb-2">Physics and Logic</label>
                <div class="flex items-center justify-between bg-slate-800 p-2 rounded mb-2">
                    <span class="text-xs">Gravity / Dynamic</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="insp-physics" class="sr-only peer">
                        <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between bg-slate-800 p-2 rounded">
                    <span class="text-xs">Tap Behavior (Mobile)</span>
                    <select id="insp-behavior" class="bg-slate-900 border border-slate-700 text-xs rounded p-1 outline-none">
                        <option value="none">None</option>
                        <option value="jump">Jump</option>
                        <option value="destroy">Destroy</option>
                        <option value="spin">Spin</option>
                    </select>
                </div>
            </div>
            
            <button id="btn-delete" class="mt-2 w-full bg-red-500/20 hover:bg-red-500/40 text-red-400 text-xs py-2 rounded border border-red-500/30 transition-colors uppercase font-bold">
                <i class="fa-solid fa-trash mr-1"></i> Delete Object
            </button>
        </div>


        <!-- BOTTOM TOOLBAR -->
        <div class="h-20 glass-panel border-t border-slate-700/50 flex items-center justify-around px-2 z-40 shrink-0 pb-2">
            
            <!-- Add Tools -->
            <div class="flex gap-4">
                <button class="tool-btn group relative flex flex-col items-center gap-1" data-type="rect">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-blue-400 group-active:scale-90 transition-transform shadow-lg shadow-black/40">
                        <i class="fa-regular fa-square"></i>
                    </div>
                    <span class="text-[10px] text-slate-400">Box</span>
                </button>
                <button class="tool-btn group relative flex flex-col items-center gap-1" data-type="circle">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-pink-400 group-active:scale-90 transition-transform shadow-lg shadow-black/40">
                        <i class="fa-regular fa-circle"></i>
                    </div>
                    <span class="text-[10px] text-slate-400">Ball</span>
                 </button>
                 <button class="tool-btn group relative flex flex-col items-center gap-1" data-type="sprite">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-yellow-400 group-active:scale-90 transition-transform shadow-lg shadow-black/40">
                        <i class="fa-solid fa-user-astronaut"></i>
                    </div>
                    <span class="text-[10px] text-slate-400">Sprite</span>
                </button>
            </div>

            <!-- Play/Stop Toggle (Center) -->
            <div class="relative -top-5">
                <button id="btn-play" class="w-16 h-16 rounded-full bg-gradient-to-tr from-green-500 to-emerald-400 flex items-center justify-center text-white text-2xl shadow-xl shadow-green-500/40 hover:scale-105 active:scale-95 transition-all border-4 border-slate-900 z-50">
                    <i class="fa-solid fa-play ml-1"></i>
                </button>
                <button id="btn-stop" class="hidden w-16 h-16 rounded-full bg-gradient-to-tr from-red-500 to-rose-400 flex items-center justify-center text-white text-2xl shadow-xl shadow-red-500/40 hover:scale-105 active:scale-95 transition-all border-4 border-slate-900 z-50">
                    <i class="fa-solid fa-stop"></i>
                </button>
            </div>

            <!-- System Tools -->
             <div class="flex gap-4">
                 <button id="btn-reset" class="group relative flex flex-col items-center gap-1">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-slate-300 group-active:scale-90 transition-transform shadow-lg shadow-black/40">
                        <i class="fa-solid fa-rotate-left"></i>
                    </div>
                    <span class="text-[10px] text-slate-400">Clear</span>
                </button>
                
                <!-- NEW JOYSTICK BUTTON -->
                <button id="btn-joystick" class="group relative flex flex-col items-center gap-1">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-indigo-400 shadow-lg group-active:scale-90 transition-transform">
                        <i class="fa-solid fa-gamepad"></i>
                    </div>
                    <span class="text-[10px] text-slate-400" id="joystick-status-text">Joystick</span>
                </button>

                <button id="btn-world-gravity" class="group relative flex flex-col items-center gap-1">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-600 flex items-center justify-center text-purple-400 shadow-lg group-active:scale-90 transition-transform" data-active="true">
                        <i class="fa-solid fa-earth-americas"></i>
                    </div>
                    <span class="text-[10px] text-purple-400 font-bold">Gravity</span>
                </button>
            </div>

        </div>

    </div>


    <!-- --- MAIN SCRIPTS --- -->
    <script>
        
        // --- GLOBAL STATE ---
        const GLOBAL_CONFIG = {
            projectName: "KodmovEdit", 
            orientation: 'portrait',
            engine: 'box2d',
            // Removed: language: 'english'
        };
        
        // Sprites available in the Asset Browser
        const SPRITE_ASSETS = [
            'üëæ', 'ü§ñ', 'üíÄ', 'üëΩ', 'üê±', 'üê∂', 'üçï', '‚≠êÔ∏è', 'üëë', 'üöÄ', 
            'üõ∏', 'üí∞', 'üîë', '‚ù§Ô∏è', 'üçÑ', 'üå≥', '‚òÅÔ∏è', '‚òÄÔ∏è', 'üíß', 'üî•',
            'ü¶†', 'üí£', 'üõ°Ô∏è', '‚öîÔ∏è', 'üèπ', 'üîÆ', 'üíé', 'üö™', 'üß±', 'üö¶'
        ];


        // --- CORE CLASSES (No translation needed here) ---

        class Vector2 {
            constructor(x, y) { this.x = x; this.y = y; }
            add(v) { this.x += v.x; this.y += v.y; return this; }
            mult(n) { this.x *= n; this.y *= n; return this; }
            dist(v) { return Math.sqrt((this.x - v.x)**2 + (this.y - v.y)**2); }
            clone() { return new Vector2(this.x, this.y); }
            normalize() {
                const mag = Math.sqrt(this.x * this.x + this.y * this.y);
                if (mag > 0) {
                    this.x /= mag;
                    this.y /= mag;
                }
                return this;
            }
        }

        class Entity {
            constructor(type, x, y) {
                this.id = Math.random().toString(36).substr(2, 9);
                this.type = type; // 'rect', 'circle', 'sprite'
                this.pos = new Vector2(x, y);
                this.vel = new Vector2(0, 0);
                this.w = 50;
                this.h = 50;
                this.color = this.randomColor();
                this.angle = 0;
                this.angularVel = 0;
                
                // Physics & Logic
                this.isStatic = false; // Default to dynamic for new non-floor objects
                this.behavior = 'none'; 
                this.sprite = this.getDefaultSprite(type); 
                this.initialState = null;
                
                // Player properties (only used by the first dynamic entity)
                this.moveSpeed = 300; 
                this.jumpStrength = -500;
                this.onGround = false;
            }

            randomColor() {
                const colors = ['#38bdf8', '#fb7185', '#4ade80', '#facc15', '#a78bfa', '#f472b6'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            getDefaultSprite(type) {
                if (type === 'sprite') return 'üëæ';
                if (type === 'circle') return 'üèÄ';
                return ''; 
            }

            saveState() {
                this.initialState = {
                    pos: this.pos.clone(),
                    vel: this.vel.clone(),
                    angle: this.angle,
                    w: this.w, h: this.h, color: this.color,
                    isStatic: this.isStatic, behavior: this.behavior, sprite: this.sprite
                };
            }

            restoreState() {
                if (!this.initialState) return;
                this.pos = this.initialState.pos.clone();
                this.vel = this.initialState.vel.clone();
                this.angle = this.initialState.angle;
                this.w = this.initialState.w;
                this.h = this.initialState.h;
                this.color = this.initialState.color;
                this.isStatic = this.initialState.isStatic;
                this.behavior = this.initialState.behavior;
                this.angularVel = 0;
                // Only restore sprite if it hasn't changed its type (e.g. from Sprite to Rect)
                if (this.type === 'sprite') {
                    this.sprite = this.initialState.sprite;
                }
            }

            contains(x, y) {
                // Simple AABB / Radius check for selection
                const isCircle = this.type === 'circle';
                const center = new Vector2(this.pos.x + this.w/2, this.pos.y + this.h/2);
                const r = this.w / 2; // Use radius for circles, and half-width/height for boxes approximation

                if (isCircle) {
                    return center.dist(new Vector2(x, y)) < r;
                } else {
                    // Simple, non-rotated bounding box check
                    return (x >= this.pos.x && x <= this.pos.x + this.w &&
                            y >= this.pos.y && y <= this.pos.y + this.h);
                }
            }

            update(dt, gravity, bounds) {
                if (this.isStatic || GLOBAL_CONFIG.engine === 'pixel') return;

                // Apply Gravity
                this.vel.y += gravity * dt;
                
                // Apply Velocity
                this.pos.add(new Vector2(this.vel.x * dt, this.vel.y * dt));
                this.angle += this.angularVel * dt;

                this.onGround = false;

                // Simple Floor Collision
                if (this.pos.y + this.h > bounds.height) {
                    this.pos.y = bounds.height - this.h;
                    this.vel.y *= -0.6; // Bounce
                    this.vel.x *= 0.9; // Friction
                    if (Math.abs(this.vel.y) < 50) this.vel.y = 0;
                    this.onGround = true;
                }

                // Walls
                if (this.pos.x < 0) {
                    this.pos.x = 0;
                    this.vel.x *= -0.6;
                }
                if (this.pos.x + this.w > bounds.width) {
                    this.pos.x = bounds.width - this.w;
                    this.vel.x *= -0.6;
                }
            }

            draw(ctx, isSelected) {
                ctx.save();
                ctx.translate(this.pos.x + this.w/2, this.pos.y + this.h/2);
                ctx.rotate(this.angle * Math.PI / 180);
                
                // Draw Selection Highlight
                if (isSelected) {
                    ctx.shadowColor = '#fff';
                    ctx.shadowBlur = 10;
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                } else {
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 5;
                }

                // Draw Base Shape
                if (this.type === 'rect') {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
                    if(isSelected) ctx.strokeRect(-this.w/2, -this.h/2, this.w, this.h);
                } else if (this.type === 'circle') {
                    ctx.beginPath();
                    ctx.fillStyle = this.color;
                    ctx.arc(0, 0, this.w/2, 0, Math.PI * 2);
                    ctx.fill();
                    if(isSelected) ctx.stroke();
                } 
                
                // Draw Sprite/Text Overlay
                if(this.sprite && this.type === 'sprite') {
                    ctx.shadowBlur = 0;
                    // Font size is based on the smaller of w or h, to fit the emoji
                    const fontSize = Math.min(this.w, this.h) * 0.8; 
                    ctx.font = `${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.sprite, 0, 5); // 5px offset for visual center
                }

                ctx.restore();
            }
        }
        
        // --- JOYSTICK CONTROLLER (No translation needed here) ---
        const joystick = {
            canvas: document.getElementById('joystick-canvas'),
            ctx: null,
            radius: 50,
            knobRadius: 20,
            center: new Vector2(60, 60),
            knobPos: new Vector2(60, 60),
            isDragging: false,
            active: false,
            
            // Movement Vector to be used by the game loop
            direction: new Vector2(0, 0),

            init: function() {
                this.ctx = this.canvas.getContext('2d');
                this.radius = this.canvas.width / 2 - 10;
                this.knobRadius = this.radius / 2.5;
                this.center = new Vector2(this.canvas.width / 2, this.canvas.height / 2);
                this.knobPos = this.center.clone();
                
                this.canvas.addEventListener('mousedown', (e) => this.handleStart(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleEnd(e));
                this.canvas.addEventListener('mouseleave', (e) => this.handleEnd(e)); // Added mouse leave
                
                this.canvas.addEventListener('touchstart', (e) => this.handleStart(e, true), {passive: false});
                this.canvas.addEventListener('touchmove', (e) => this.handleMove(e, true), {passive: false});
                this.canvas.addEventListener('touchend', (e) => this.handleEnd(e));
                this.canvas.addEventListener('touchcancel', (e) => this.handleEnd(e));
            },
            
            getTouchPos: function(e, isTouch) {
                const rect = this.canvas.getBoundingClientRect();
                const touch = isTouch ? (e.touches[0] || e.changedTouches[0]) : e;
                return { 
                    x: touch.clientX - rect.left, 
                    y: touch.clientY - rect.top 
                };
            },

            draw: function() {
                if (!this.active || game.mode !== 'play') return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw Base/Background (Large transparent circle)
                this.ctx.beginPath();
                this.ctx.arc(this.center.x, this.center.y, this.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                this.ctx.fill();
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();

                // Draw Knob (Small draggable circle)
                this.ctx.beginPath();
                this.ctx.arc(this.knobPos.x, this.knobPos.y, this.knobRadius, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(99, 102, 241, 0.9)'; // Indigo
                this.ctx.shadowColor = 'rgba(99, 102, 241, 0.5)';
                this.ctx.shadowBlur = 15;
                this.ctx.fill();
                this.ctx.shadowBlur = 0;
            },
            
            handleStart: function(e, isTouch = false) {
                if (!this.active) return;
                e.preventDefault(); 
                this.isDragging = true;
                this.handleMove(e, isTouch);
            },

            handleMove: function(e, isTouch = false) {
                if (!this.isDragging || !this.active) return;
                e.preventDefault(); 
                
                const pos = this.getTouchPos(e, isTouch);
                
                const dx = pos.x - this.center.x;
                const dy = pos.y - this.center.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                // Limit movement within the base circle
                if (dist > this.radius) {
                    const angle = Math.atan2(dy, dx);
                    this.knobPos.x = this.center.x + this.radius * Math.cos(angle);
                    this.knobPos.y = this.center.y + this.radius * Math.sin(angle);
                } else {
                    this.knobPos.x = pos.x;
                    this.knobPos.y = pos.y;
                }
                
                // Calculate and store the normalized direction vector for the game loop
                this.direction.x = (this.knobPos.x - this.center.x) / this.radius;
                this.direction.y = (this.knobPos.y - this.center.y) / this.radius;
            },

            handleEnd: function(e) {
                this.isDragging = false;
                // Snap knob back to center and reset direction
                this.knobPos = this.center.clone();
                this.direction.x = 0;
                this.direction.y = 0;
            },

            // Resets knob position and direction
            reset: function() {
                this.knobPos = this.center.clone();
                this.direction.x = 0;
                this.direction.y = 0;
                this.isDragging = false;
            }
        };


        // --- APP CONTROLLER (Scene Management & Global UI) ---

        const app = {
            currentScene: 'intro',
            
            switchScene: (sceneName) => {
                const currentSceneElement = document.getElementById(`scene-${app.currentScene}`);
                const targetSceneElement = document.getElementById(`scene-${sceneName}`);

                if (currentSceneElement) {
                    currentSceneElement.classList.remove('active');
                }
                if (targetSceneElement) {
                    targetSceneElement.classList.add('active');
                    targetSceneElement.classList.add('anim-fade-in');
                }

                app.currentScene = sceneName;

                if(sceneName === 'editor') {
                    game.resize();
                    game.start();
                    document.getElementById('editor-project-name').innerText = GLOBAL_CONFIG.projectName;
                    game.setupInitialScene();
                    game.updateGravityButtonUI();
                    game.populateSpritePicker();
                    joystick.init(); // Initialize joystick canvas here
                } else {
                    game.stop(); 
                    game.closeInspector();
                    game.toggleJoystick(false); // Hide joystick when leaving editor
                }
            },

            showToast: (msg) => {
                const toast = document.getElementById('toast');
                const txt = document.getElementById('toast-msg');
                txt.innerText = msg;
                toast.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    toast.style.transform = 'translate(-50%, -100px)';
                }, 2000);
            },
            
            // About Dialog Functions
            openAboutDialog: () => {
                document.getElementById('about-dialog').classList.add('active');
            },

            closeAboutDialog: () => {
                document.getElementById('about-dialog').classList.remove('active');
            },

            // Logic for Create Project Scene
            selectOption: (group, element, value) => {
                GLOBAL_CONFIG[group] = value;
                
                // Deselect all siblings within the same parent grid
                const container = element.parentElement;
                container.querySelectorAll('.option-card').forEach(el => {
                    el.classList.remove('selected');
                    
                    // Specific logic for Engine options (to handle the unique icon)
                    if (group === 'engine') {
                        const icon = el.querySelector('.check-icon');
                        if (icon) {
                            icon.classList.remove('fa-circle-check', 'text-indigo-400');
                            icon.classList.add('fa-regular', 'fa-circle', 'text-slate-600');
                        }
                    }
                });

                // Select the current element
                element.classList.add('selected');

                // Specific logic for Engine options (to handle the unique icon)
                if (group === 'engine') {
                    const icon = element.querySelector('.check-icon');
                    if (icon) {
                        icon.className = icon.className.replace('fa-regular', 'fa-solid');
                        icon.className = icon.className.replace('fa-circle', 'fa-circle-check');
                        icon.classList.remove('text-slate-600');
                        icon.classList.add('text-indigo-400');
                    }
                }
                
                // Update Gravity Button text based on selected engine
                if (group === 'engine') {
                    game.updateGravityButtonUI(value);
                }
            },
            
            createProject: () => {
                const nameInput = document.getElementById('inp-name');
                const name = nameInput.value.trim();
                GLOBAL_CONFIG.projectName = name || "KodmovEdit"; 

                if(!name) {
                    app.showToast("Project Name Required!");
                    return;
                }

                const overlay = document.getElementById('loading-overlay');
                const status = document.getElementById('loading-status');
                overlay.style.display = 'flex';

                const steps = [
                    "Allocating Memory...",
                    `Configuring ${GLOBAL_CONFIG.engine.toUpperCase()} Core...`,
                    "Building Starter Assets...",
                    "Ready! Entering Editor..."
                ];

                let step = 0;
                const interval = setInterval(() => {
                    status.innerText = steps[step];
                    step++;
                    if(step >= steps.length) {
                        clearInterval(interval);
                        setTimeout(() => {
                            overlay.style.display = 'none';
                            app.switchScene('editor');
                        }, 500);
                    }
                }, 600);
            }
        };


        // --- GAME MAKER (EDITOR) LOGIC ---
        
        const game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            width: 0, height: 0,
            entities: [],
            selectedId: null,
            mode: 'edit', // 'edit' or 'play'
            isDragging: false,
            dragOffset: new Vector2(0,0),
            gravity: 900,
            isRunning: false,

            // DOM Elements Reference
            els: {
                inspector: document.getElementById('inspector'),
                btnPlay: document.getElementById('btn-play'),
                btnStop: document.getElementById('btn-stop'),
                playIndicator: document.getElementById('play-indicator'),
                inspColor: document.getElementById('insp-color'),
                inspW: document.getElementById('insp-w'),
                inspH: document.getElementById('insp-h'),
                inspR: document.getElementById('insp-r'),
                inspPhysics: document.getElementById('insp-physics'),
                inspBehavior: document.getElementById('insp-behavior'),
                valW: document.getElementById('val-w'),
                valH: document.getElementById('val-h'),
                valR: document.getElementById('insp-r'),
                inspSpriteRow: document.getElementById('insp-sprite-row'),
                inspCurrentSprite: document.getElementById('insp-current-sprite'),
                btnWorldGravity: document.getElementById('btn-world-gravity'),
                btnJoystick: document.getElementById('btn-joystick'),
                joystickOverlay: document.getElementById('joystick-overlay'),
                joystickDialog: document.getElementById('joystick-dialog'),
                joystickStatusText: document.getElementById('joystick-status-text'),
            },

            init: function() {
                // Attach event listeners only once
                this.canvas.addEventListener('mousedown', (e) => this.handleStart(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleEnd(e));
                this.canvas.addEventListener('touchstart', (e) => this.handleStart(e, true), {passive: false});
                this.canvas.addEventListener('touchmove', (e) => this.handleMove(e, true), {passive: false});
                this.canvas.addEventListener('touchend', (e) => this.handleEnd(e));
                
                document.querySelectorAll('.tool-btn').forEach(btn => btn.addEventListener('click', (e) => this.addEntity(btn.dataset.type)));
                document.getElementById('close-inspector').addEventListener('click', () => this.closeInspector());
                document.getElementById('btn-delete').addEventListener('click', () => this.deleteSelected());
                document.getElementById('btn-play').addEventListener('click', () => this.setMode('play'));
                document.getElementById('btn-stop').addEventListener('click', () => this.setMode('edit'));
                document.getElementById('btn-reset').addEventListener('click', () => this.clearScene());
                this.els.btnWorldGravity.addEventListener('click', () => this.toggleGravity());
                this.els.btnJoystick.addEventListener('click', () => this.openJoystickDialog());

                // Inspector Inputs
                this.els.inspColor.addEventListener('input', (e) => { const ent = this.getSelected(); if(ent) ent.color = e.target.value; });
                this.els.inspW.addEventListener('input', (e) => { const ent = this.getSelected(); if(ent) { ent.w = parseInt(e.target.value); this.updateValLabels(); } });
                this.els.inspH.addEventListener('input', (e) => { const ent = this.getSelected(); if(ent) { ent.h = parseInt(e.target.value); this.updateValLabels(); } });
                this.els.inspR.addEventListener('input', (e) => { const ent = this.getSelected(); if(ent) { ent.angle = parseInt(e.target.value); this.updateValLabels(); } });
                this.els.inspPhysics.addEventListener('change', (e) => { const ent = this.getSelected(); if(ent) ent.isStatic = !e.target.checked; });
                this.els.inspBehavior.addEventListener('change', (e) => { const ent = this.getSelected(); if(ent) ent.behavior = e.target.value; });
                
                this.updateGravityButtonUI(GLOBAL_CONFIG.engine);
            },

            start: function() {
                if(this.isRunning) return;
                this.isRunning = true;
                this.loop();
            },

            stop: function() {
                this.isRunning = false;
            },

            resize: function() {
                const container = document.getElementById('editor-container');
                this.width = container.clientWidth;
                this.height = container.clientHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                
                // Adjust floor/bounds if entities exist
                this.entities.forEach(ent => {
                    if (ent.type === 'rect' && ent.isStatic && ent.pos.y > this.height - 50) {
                         ent.pos.y = this.height - 40;
                         ent.w = this.width;
                    }
                });
            },
            
            // --- Joystick Functions ---
            openJoystickDialog: function() {
                // If already active, just toggle it off
                if (joystick.active) {
                    this.toggleJoystick(false);
                } else {
                    this.els.joystickDialog.classList.add('active');
                }
            },
            
            toggleJoystick: function(state) {
                joystick.active = state;
                this.els.joystickDialog.classList.remove('active');
                
                if (state) {
                    this.els.joystickOverlay.classList.remove('hidden');
                    this.els.joystickStatusText.classList.add('font-bold', 'text-indigo-400');
                    app.showToast("Joystick: ON.");
                } else {
                    this.els.joystickOverlay.classList.add('hidden');
                    this.els.joystickStatusText.classList.remove('font-bold', 'text-indigo-400');
                    joystick.reset();
                    app.showToast("Joystick: OFF.");
                }
            },
            

            // --- Scene Setup ---
            setupInitialScene: function() {
                this.entities = [];
                this.selectedId = null;
                
                // Add Floor Entity (Static)
                const floor = new Entity('rect', 0, this.height - 40);
                floor.w = this.width; floor.h = 40; floor.color = '#334155'; floor.isStatic = true;
                this.entities.push(floor);

                // Add a dynamic object (The Player/Controllable Sprite)
                const player = new Entity('sprite', this.width/2 - 25, 100);
                player.isStatic = false; 
                player.sprite = 'üëæ';
                player.behavior = 'jump'; // Can still jump with tap
                this.entities.push(player);
                
                app.showToast("Editor Loaded! Drag Objects to Edit.");
            },
            
            // --- Loop ---
            loop: function(timestamp) {
                if(!this.isRunning) return;
                
                const dt = (timestamp - (this.lastTime || timestamp)) / 1000 || 0;
                this.lastTime = timestamp;

                this.update(dt);
                this.draw();
                
                // Draw joystick in the game loop
                if (joystick.active) {
                    joystick.draw();
                }
                
                requestAnimationFrame((t) => this.loop(t));
            },

            update: function(dt) {
                const player = this.entities.find(e => !e.isStatic); // First non-static entity is the player
                
                // Joystick Control Logic
                if (this.mode === 'play' && joystick.active && player) {
                    
                    // Apply horizontal movement based on joystick direction
                    const targetVelX = joystick.direction.x * player.moveSpeed;
                    
                    // Smooth transition to target velocity
                    player.vel.x += (targetVelX - player.vel.x) * 0.1; 
                    
                    // Tap to jump using Joystick area (if no tap behavior is assigned)
                    // (Assuming we only control the first dynamic object)
                    if (joystick.direction.y < -0.5 && player.onGround) {
                         player.vel.y = player.jumpStrength;
                    }
                }
                
                // Physics Update (only in Play mode)
                if (this.mode === 'play' && GLOBAL_CONFIG.engine === 'box2d') {
                    const currentGravity = this.els.btnWorldGravity.dataset.active === 'true' ? this.gravity : 0;
                    this.entities.forEach(ent => {
                        ent.update(dt, currentGravity, {width: this.width, height: this.height});
                    });
                }
            },

            draw: function() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                this.entities.forEach(ent => {
                    ent.draw(this.ctx, this.mode === 'edit' && ent.id === this.selectedId);
                });
            },

            // --- Interaction Handlers ---
            getTouchPos: function(e, isTouch) {
                const rect = this.canvas.getBoundingClientRect();
                const touch = isTouch ? (e.touches[0] || e.changedTouches[0]) : e;
                return new Vector2(touch.clientX - rect.left, touch.clientY - rect.top);
            },
            
            handleStart: function(e, isTouch = false) {
                if (isTouch && e.touches.length > 1) return; // Ignore multi-touch for now
                const pos = this.getTouchPos(e, isTouch);
                
                if (this.mode === 'play') {
                    // Play Mode: Check for tap behavior
                    // Check if tap is outside the joystick area if active
                    const joystickRect = this.els.joystickOverlay.getBoundingClientRect();
                    const canvasRect = this.canvas.getBoundingClientRect();
                    
                    // Calculate joystick position relative to canvas
                    const jx = joystickRect.left - canvasRect.left;
                    const jy = joystickRect.top - canvasRect.top;
                    const jw = joystickRect.width;
                    const jh = joystickRect.height;
                    
                    const tapInJoystickArea = pos.x >= jx && pos.x <= jx + jw && 
                                              pos.y >= jy && pos.y <= jy + jh;

                    if (joystick.active && tapInJoystickArea) {
                        return; // Ignore tap if it's on the joystick overlay
                    }

                    for (let i = this.entities.length - 1; i >= 0; i--) {
                        const ent = this.entities[i];
                        if (ent.contains(pos.x, pos.y)) {
                            this.triggerBehavior(ent);
                            return; 
                        }
                    }
                    return;
                }

                // Edit Mode: Selection Logic
                let clicked = null;
                for (let i = this.entities.length - 1; i >= 0; i--) {
                    const ent = this.entities[i];
                    if (ent.contains(pos.x, pos.y)) {
                        clicked = ent;
                        break;
                    }
                }

                if (clicked) {
                    this.selectedId = clicked.id;
                    this.isDragging = true;
                    this.dragOffset = new Vector2(pos.x - clicked.pos.x, pos.y - clicked.pos.y);
                    this.openInspector(clicked);
                } else {
                    this.selectedId = null;
                    this.closeInspector();
                }
            },

            handleMove: function(e, isTouch = false) {
                if (this.mode !== 'edit' || !this.isDragging || !this.selectedId) return;
                e.preventDefault(); 
                const pos = this.getTouchPos(e, isTouch);
                const ent = this.getSelected();
                if (ent) {
                    // Don't drag static floor object
                    if (ent.isStatic && ent.pos.y > this.height - 50) return;
                    
                    ent.pos.x = pos.x - this.dragOffset.x;
                    ent.pos.y = pos.y - this.dragOffset.y;
                }
            },

            handleEnd: function(e) {
                this.isDragging = false;
            },

            // --- Editor Tools ---

            setMode: function(newMode) {
                this.mode = newMode;
                if (newMode === 'play') {
                    this.entities.forEach(ent => ent.saveState());
                    this.selectedId = null;
                    this.closeInspector();
                    this.els.btnPlay.classList.add('hidden');
                    this.els.btnStop.classList.remove('hidden');
                    this.els.playIndicator.classList.remove('hidden');
                    app.showToast("Starting Game Simulation...");
                } else {
                    this.entities.forEach(ent => ent.restoreState());
                    this.entities.forEach(e => { e.vel = new Vector2(0,0); e.angularVel = 0; });
                    this.els.btnStop.classList.add('hidden');
                    this.els.btnPlay.classList.remove('hidden');
                    this.els.playIndicator.classList.add('hidden');
                    app.showToast("Returning to Editor Mode.");
                }
            },
            
            toggleGravity: function() {
                const btn = this.els.btnWorldGravity;
                const isActive = btn.dataset.active === 'true';
                
                if (GLOBAL_CONFIG.engine === 'box2d') {
                     btn.dataset.active = isActive ? 'false' : 'true';
                    
                    const icon = btn.querySelector('i');
                    const span = btn.querySelector('span');

                    if (isActive) {
                        icon.classList.remove('text-purple-400');
                        icon.classList.add('text-slate-500');
                        span.innerText = 'Off';
                        app.showToast("Gravity: Disabled.");
                    } else {
                        icon.classList.add('text-purple-400');
                        icon.classList.remove('text-slate-500');
                        span.innerText = 'Gravity';
                        app.showToast("Gravity: Enabled.");
                    }
                } else {
                     // For Pixel Grid mode, the button acts as a grid density toggle (conceptual)
                     const currentOpacity = parseFloat(this.canvas.style.opacity || 1);
                     this.canvas.style.opacity = currentOpacity < 1 ? 1 : 0.8;
                     app.showToast(`Grid Density: ${currentOpacity < 1 ? 'High' : 'Normal'}`);
                }
            },
            
            updateGravityButtonUI: function(engineType) {
                const btn = this.els.btnWorldGravity;
                const icon = btn.querySelector('i');
                const span = btn.querySelector('span');

                if (engineType === 'pixel') {
                    icon.classList.replace('fa-earth-americas', 'fa-map');
                    span.innerText = 'Grid';
                    span.classList.replace('text-purple-400', 'text-pink-400');
                    span.classList.remove('font-bold');
                    btn.dataset.active = 'false'; // Gravity is physically off in pixel mode
                } else {
                    icon.classList.replace('fa-map', 'fa-earth-americas');
                    span.innerText = 'Gravity';
                    span.classList.replace('text-pink-400', 'text-purple-400');
                    span.classList.add('font-bold');
                    btn.dataset.active = 'true'; // Gravity starts on in box2d mode
                }
            },


            // --- Entity Management ---

            addEntity: function(type) {
                if (this.mode === 'play') return;
                const pad = 50;
                const x = pad + Math.random() * (this.width - pad*2);
                const y = pad + Math.random() * (this.height/2);
                
                const ent = new Entity(type, x, y);
                
                this.entities.push(ent);
                this.selectedId = ent.id;
                this.openInspector(ent);
                app.showToast(`Added ${type.toUpperCase()}`);
            },
            
            getSelected: function() {
                return this.entities.find(e => e.id === this.selectedId);
            },
            
            deleteSelected: function() {
                 if(this.selectedId) {
                    this.entities = this.entities.filter(e => e.id !== this.selectedId);
                    this.selectedId = null;
                    this.closeInspector();
                    app.showToast("Object Deleted.");
                }
            },
            
            clearScene: function() {
                 // Replaced alert() with a modal/confirmation dialog equivalent
                 // Pinalitan ang window.confirm dahil hindi ito gumagana sa iFrame, at gumamit ng toast
                 // Ipapalagay na lang muna na gusto nilang i-clear ang scene.
                 this.setupInitialScene();
                 app.showToast("Scene Cleared.");
            },

            triggerBehavior: function(ent) {
                const player = this.entities.find(e => !e.isStatic); // First dynamic entity
                
                // If the player is the one tapped, and joystick is off or it's a dedicated tap jump
                if (player === ent && ent.behavior === 'jump' && ent.onGround) {
                    ent.vel.y = ent.jumpStrength;
                } else if (ent.behavior === 'destroy') {
                    this.entities = this.entities.filter(e => e.id !== ent.id);
                    this.selectedId = null;
                } else if (ent.behavior === 'spin') {
                    ent.angularVel = 500;
                    ent.vel.y = -300;
                }
            },

            // --- Inspector ---
            openInspector: function(ent) {
                this.els.inspector.classList.add('active');
                
                // Populate Fields
                document.getElementById('insp-type').innerText = ent.type.toUpperCase();
                this.els.inspColor.value = ent.color;
                this.els.inspW.value = ent.w;
                this.els.inspH.value = ent.h;
                this.els.inspR.value = ent.angle;
                this.els.inspPhysics.checked = !ent.isStatic;
                this.els.inspBehavior.value = ent.behavior;
                
                // Show/Hide Sprite Picker Row
                if (ent.type === 'sprite') {
                    this.els.inspSpriteRow.classList.remove('hidden');
                    this.els.inspCurrentSprite.innerText = ent.sprite;
                } else {
                    this.els.inspSpriteRow.classList.add('hidden');
                }

                this.updateValLabels();
            },

            closeInspector: function() {
                this.els.inspector.classList.remove('active');
            },
            
            updateValLabels: function() {
                this.els.valW.innerText = this.els.inspW.value;
                this.els.valH.innerText = this.els.inspH.value;
                this.els.valR.innerText = this.els.inspR.value + '¬∞';
            },
            
            // --- SPRITE PICKER LOGIC ---
            populateSpritePicker: function() {
                const grid = document.getElementById('sprite-grid');
                grid.innerHTML = '';
                SPRITE_ASSETS.forEach(sprite => {
                    const btn = document.createElement('button');
                    btn.className = 'text-3xl p-2 rounded-lg bg-slate-800 hover:bg-slate-700 active:scale-90 transition-transform';
                    btn.innerText = sprite;
                    btn.onclick = () => this.selectSprite(sprite);
                    grid.appendChild(btn);
                });
            },
            
            openSpritePicker: function() {
                if (this.mode === 'play') return;
                document.getElementById('sprite-picker').classList.add('active');
            },
            
            closeSpritePicker: function() {
                document.getElementById('sprite-picker').classList.remove('active');
            },
            
            selectSprite: function(sprite) {
                const ent = this.getSelected();
                if (ent && ent.type === 'sprite') {
                    ent.sprite = sprite;
                    this.els.inspCurrentSprite.innerText = sprite;
                    this.closeSpritePicker();
                    app.showToast(`Sprite Updated: ${sprite}`);
                }
            }

        };


        // --- BACKGROUND ANIMATION (Grid) ---
        const bgGrid = {
            canvas: document.getElementById('bgCanvas'),
            ctx: document.getElementById('bgCanvas').getContext('2d'),
            width: 0, height: 0,
            offset: 0,

            init: function() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.draw();
            },

            resize: function() {
                this.width = this.canvas.width = window.innerWidth;
                this.height = this.canvas.height = window.innerHeight;
            },

            draw: function() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.ctx.strokeStyle = '#6366f1';
                this.ctx.lineWidth = 1;
                this.ctx.globalAlpha = 0.2; // Opacity for background grid
                
                const gridSize = 40;
                this.offset = (this.offset + 0.1) % gridSize;

                this.ctx.beginPath();
                // Draw horizontal lines with subtle shift
                for(let y = 0; y < this.height; y += gridSize) {
                    this.ctx.moveTo(0, y + this.offset);
                    this.ctx.lineTo(this.width, y + this.offset);
                }
                // Draw vertical lines with subtle shift
                for(let x = 0; x < this.width; x += gridSize) {
                    this.ctx.moveTo(x + this.offset, 0);
                    this.ctx.lineTo(x + this.offset, this.height);
                }
                this.ctx.stroke();
                requestAnimationFrame(() => this.draw());
            }
        };

        // --- BOOTSTRAP ---
        window.onload = () => {
            bgGrid.init();
            game.init();
            joystick.init();
            app.switchScene('intro');
            game.updateGravityButtonUI(GLOBAL_CONFIG.engine);
            // Language related code removed
        };

    </script>
</body>
</html>

